<%-- 
    Document   : user
    Created on : 1.3.2017, 13:39:22
    Author     : fourtti>
--%>

<%@page contentType="text/html" pageEncoding="UTF-8"%>
<!DOCTYPE html>
<html>
    <head>

        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <link rel="stylesheet" type="text/css" href="css/css.css">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

        <title>NotMalware</title>


        <script>

            <%
                String userName = null;
                Cookie[] cookies = request.getCookies();
                if (cookies != null) {
                    for (Cookie cookie : cookies) {
                        if (cookie.getName().equals("user")) {
                            userName = cookie.getValue();
                        }
                    }
                }
                if (userName == null) {
                    response.sendRedirect("Landing.jsp");
                }
            %>

            function loadUnassigned() {
                // dont ask
                $.ajax({
                    url: '/NotMalware/webresources/person/UnassignedNotes',
                    type: 'GET',
                    dataType: 'xml',
                    success: function (data) {
                        jQuery('#left-tab').html('');
                        for (var i = 0; i < data.getElementsByTagName("note").length; i++) {
                            var task = $("<div id='moveable' value='xx' class='ui-widget-header ui-draggable ui-draggable-handle'>\n\
                                <span id='titletext'>" + data.getElementsByTagName("note")[i].getElementsByTagName("id")[0].innerHTML + "#   " + data.getElementsByTagName("note")[i].getElementsByTagName("heading")[0].innerHTML + " <span id='taskremove'class='glyphicon glyphicon-remove-circle'></span></span>\n\
                                <textarea class='form-control' rows='5' id='notetext' placeholder='insert note text'>" + data.getElementsByTagName("note")[i].getElementsByTagName("content")[0].innerHTML + "</textarea></div>");
                            addTask(task, "left");
                        }
                    }

                });
            }

            function loadPersonTasks() {
                var userName = '<%=userName%>';
                var string = "/NotMalware/webresources/person/" + userName + "/Note";
                $.ajax({
                    url: string,
                    type: 'GET',
                    async: false,
                    success: function (data) {
                        if (data.getElementsByTagName("note").length == 0) {
                            console.log("Empty");
                        } else {
                            jQuery('#middle-tab').html('');
                            for (var i = 0; i < data.getElementsByTagName("note").length; i++) {
                                var task = $("<div id='moveable' value='xx' class='ui-widget-header ui-draggable ui-draggable-handle'>\n\
                                <span id='titletext'>" + data.getElementsByTagName("note")[i].getElementsByTagName("id")[0].innerHTML + "#   " + data.getElementsByTagName("note")[i].getElementsByTagName("heading")[0].innerHTML + " <span id='taskremove'class='glyphicon glyphicon-remove-circle'></span></span>\n\
                                <textarea class='form-control' rows='5' id='notetext' placeholder='insert note text'>" + data.getElementsByTagName("note")[i].getElementsByTagName("content")[0].innerHTML + "</textarea></div>");
                                addTask(task, "center");
                            }
                        }
                    }
                });
            }

            function loadCompletedTasks() {
                var userName = '<%=userName%>';
                var string = "/NotMalware/webresources/person/" + userName + "/DoneNotes";

                $.ajax({
                    url: string,
                    type: 'GET',
                    async: false,
                    success: function (data) {
                        if (data.getElementsByTagName("note").length == 0) {
                            console.log("Empty");
                        } else {
                            jQuery('#right-tab').html('');
                            for (var i = 0; i < data.getElementsByTagName("note").length; i++) {
                                var task = $("<div id='moveable' value='xx' class='ui-widget-header ui-draggable ui-draggable-handle'>\n\
                                        <span id='titletext'>" + data.getElementsByTagName("note")[i].getElementsByTagName("id")[0].innerHTML + "#   " + data.getElementsByTagName("note")[i].getElementsByTagName("heading")[0].innerHTML + " <span id='taskremove'class='glyphicon glyphicon-remove-circle'></span></span>\n\
                                        <textarea class='form-control' rows='5' id='notetext' placeholder='insert note text'>" + data.getElementsByTagName("note")[i].getElementsByTagName("content")[0].innerHTML + "</textarea></div>");
                                addTask(task, "right");
                            }
                        }
                    }
                });
            }

            function addTask(note, where) {
                if (where === "left") {
                    $("#left-tab").prepend(note);
                } else if (where === "center") {
                    $("#middle-tab").prepend(note);
                } else if (where === "right") {
                    $("#right-tab").prepend(note);
                }

                $("#moveable").draggable({
                    connectWith: "#left-tab, #middle-tab, #right-tab"
                });
                $(".droppable").droppable({
                    accept: "#moveable",
                    drop: function (event, ui) {
                        var dropped = ui.draggable;
                        var droppedOn = $(this);
                        if (droppedOn.attr('id') === "middle-tab") {
                            console.log("KAlle");
                            var id = dropped[0].innerText.split("#");
                            addTaskToPerson(id[0]);
                        } else if (droppedOn.attr('id') === "right-tab") {
                            var id = dropped[0].innerText.split("#");
                            console.log("keppana");
                            fromPersonToCompleted(id[0]);
                        }
                        droppedOn.append($(dropped).removeAttr('style').css({position: "relative"}));
                    }
                });
            }

            function addTaskToPerson(id) {
                var userName = '<%=userName%>';
                var string = "/NotMalware/webresources/person/" + userName + "/Notes";
                $.ajax({
                    url: string,
                    type: 'PUT',
                    data: id,
                    contentType: 'text/plain',
                    async: false,
                    success: function (data) {

                    }
                });
            }

            function fromPersonToCompleted(id) {
                var userName = '<%=userName%>';
                console.log(userName);
                var string = "/NotMalware/webresources/person/" + userName + "/DoneNotes";
                console.log(id);
                $.ajax({
                    url: string,
                    type: 'PUT',
                    data: id,
                    contentType: 'text/plain',
                    async: false,
                    success: function (data) {
                        console.log("das");
                        console.log(data);
                    }, error: function (event) {
                        console.log("asd");
                        console.log(JSON.stringify(event));
                    }
                });
            }

            $(document).ready(function () {
                // Get the modal
                var modal = document.getElementById('myModal');

                // Get the <span> element that closes the modal
                var span = document.getElementsByClassName("close")[0];

                // Get the task adding button
                var add = document.getElementById('addtask');

                // When the user clicks on <span> (x), close the modal
                span.onclick = function () {
                    modal.style.display = "none";
                };

                // When the user clicks anywhere outside of the modal, close it
                window.onclick = function (event) {
                    if (event.target === modal) {
                        modal.style.display = "none";
                    }
                };
                $("button[name='openmodal']").click(function () {
                    modal.style.display = "block";
                });
                // When the user adds note, close modal
                window.onclick = function (event) {
                    if (event.target === add) {
                        modal.style.display = "none";
                    }
                };

                $("button[name='addtask']").click(function () {
                    var header = titletextmodal.value;
                    var message = contenttextmodal.value;

                    titletextmodal.value = "";
                    contenttextmodal.value = "";

                    $.ajax({
                        url: '/NotMalware/webresources/person/note',
                        type: 'PUT',
                        data: header + "," + message,
                        contentType: 'text/plain',
                        async: false,
                        success: function (data) {
                        }
                    });

                    loadUnassigned();
                });

                loadUnassigned();
                loadPersonTasks();
                loadCompletedTasks();
                //$("moveable").sortable();
            }
            );


        </script>

        <!--        <script>
        
                </script>-->
    </head>
    <body>

        <nav id="header">
            <img src="css/img/logo.png" alt="Masterful design" id="logo">
            <form action="LogoutServlet" method="post">
                <input type="submit" role="button" value="Logout" id="logout" class="form-control btn btn-info note-input">
            </form>
            <a href="EditProfile.jsp" id="edit" role="button" class="form-control btn btn-info note-input" >Edit profile</a>
            <a href="AboutUs.jsp" id="about" role="button" type="button" class="form-control btn btn-info note-input" >About us</a>
            <a href="User.jsp" id="user" role="button" class="form-control btn btn-info note-input" >User</a>
            <br style="clear: both;" />
        </nav>


        <button id="openmodal" name="openmodal" class="btn btn-primary">Add Task</button>

        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <textarea placeholder="Add Title" id="titletextmodal"></textarea>
                <textarea placeholder="Add Content" id="contenttextmodal"></textarea>
                <button id="addtask" name="addtask" type="button" class="btn btn-primary">Add task</button>
            </div>
        </div>
        <div id="taskdiv">
            <h4 id="taskdivname">Open tasks</h4>
            <h4 id="taskdivname">Your tasks</h4>
            <h4 id="taskdivname">Finished tasks</h4>
        </div>
        <div id="usertabs">

            <div id="left-tab" class="droppable"></div>
            <div id="middle-tab" class="droppable"></div>
            <div id="right-tab" class="droppable"></div>
            <br style="clear: both;" />
        </div>


    </body>
</html>