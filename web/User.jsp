<%-- 
    Document   : user
    Created on : 1.3.2017, 13:39:22
    Author     : fourtti>
--%>

<%@page contentType="text/html" pageEncoding="UTF-8"%>
<!DOCTYPE html>
<html>
    <head>

        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <link rel="stylesheet" type="text/css" href="css/css.css">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

        <title>NotMalware</title>


        <script>
            // Cookie check
            <%
                String userName = null;
                Cookie[] cookies = request.getCookies();
                if (cookies != null) {
                    for (Cookie cookie : cookies) {
                        if (cookie.getName().equals("user")) {
                            userName = cookie.getValue();
                        }
                    }
                }
                // If the cookie doesn't have the correct username -> back to the front page
                if (userName == null) {
                    response.sendRedirect("Landing.jsp");
                }
            %>

            // Taskmaker to make the notes;
            function taskMaker(data, i) {
                var job = data.getElementsByTagName("note")[i].getElementsByTagName("accessLevel")[0].innerHTML;
                var jobname = "";
                if (job === "0") {
                    jobname = "Manager";
                } else if (job === "1") {
                    jobname = "Logistics";
                } else if (job === "2") {
                    jobname = "Packer";
                } else if (job === "3") {
                    jobname = "Maintenance";
                } else if (job === "4") {
                    jobname = "Janitor";
                }
                
                var id = data.getElementsByTagName("note")[i].getElementsByTagName("id")[0].innerHTML;
                var heading = data.getElementsByTagName("note")[i].getElementsByTagName("heading")[0].innerHTML;
                var content = data.getElementsByTagName("note")[i].getElementsByTagName("content")[0].innerHTML;
                var userName = data.getElementsByTagName("note")[i].getElementsByTagName("creator")[0].innerHTML;

                var task = $("<div class='moveable ui-widget-header ui-draggable ui-draggable-handle'>\n\
                                <span id='titletext'>" + id + "#   " + heading + " <span id='taskremove'class='glyphicon glyphicon-remove-circle'></span>" + "<div style='float: right;'>" + userName + "&nbsp; &nbsp;" + "</div>" + "</span>\n\
                                <div class='form-control' rows='5' id='notetext' placeholder='insert note text'>" + content + "<div style='border: 1px solid black; float: right; position: relative'>" + jobname + "</div></div></div>");

                console.log(task);
                return task;
            }

            function loadUnassigned() {
                // dont ask
                var job = '<%=userName%>';
                var string = '/NotMalware/webresources/person/' + job + '/UnassignedNotes';
                $.ajax({
                    url: string,
                    type: 'GET',
                    dataType: 'xml',
                    success: function (data) {
                        if (data.getElementsByTagName("note").length === 0) {
                            console.log("Unassigned Empty");
                        } else {
                            // Creating the notes to the middle panel.
                            jQuery('#left-tab').html('');
                            for (var i = 0; i < data.getElementsByTagName("note").length; i++) {
                                var task = taskMaker(data, i);
                                addTask(task, "left");
                            }
                        }
                    }

                });
            }

            // Function to refresh persons tasks -panel
            function loadPersonTasks() {
                var userName = '<%=userName%>';
                var string = "/NotMalware/webresources/person/" + userName + "/Note";
                $.ajax({
                    url: string,
                    type: 'GET',
                    dataType: 'xml',
                    success: function (data) {
                        if (data.getElementsByTagName("note").length === 0) {
                            console.log("Person Empty");
                        } else {
                            // Creating the notes to the middle panel.
                            jQuery('#middle-tab').html('');
                            for (var i = 0; i < data.getElementsByTagName("note").length; i++) {
                                var task = taskMaker(data, i);
                                addTask(task, "center");
                            }
                        }
                    }
                });
            }

            // Function to refresh completed tasks -panel
            function loadCompletedTasks() {
                var userName = '<%=userName%>';
                var string = "/NotMalware/webresources/person/" + userName + "/DoneNotes";
                $.ajax({
                    url: string,
                    type: 'GET',
                    dataType: 'xml',
                    success: function (data) {
                        if (data.getElementsByTagName("note").length === 0) {
                            console.log("Completed Empty");
                        } else {
                            // Creating the notes to the right panel.
                            jQuery('#right-tab').html('');
                            for (var i = 0; i < data.getElementsByTagName("note").length; i++) {
                                var task = taskMaker(data, i);
                                addTask(task, "right");
                            }
                        }
                    }
                });
            }

            // Adding tasks with the certain note and panel as parameters
            function addTask(note, where) {
                // Setting the note to a panel where it's dropped
                if (where === "left") {
                    $("#left-tab").prepend(note);
                } else if (where === "center") {
                    $("#middle-tab").prepend(note);
                } else if (where === "right") {
                    $("#right-tab").prepend(note);
                }

                $(".moveable").draggable({
                    connectWith: "#left-tab, #middle-tab, #right-tab",
                    disable: false
                });
                // The dropping
                $(".droppable").droppable({
                    accept: ".moveable",
                    drop: function (event, ui) {
                        var dropped = ui.draggable;
                        var droppedOn = $(this);
                        // Checking the panel where it's dropped
                        if (droppedOn.attr('id') === "middle-tab") {
                            // Getting the notes id
                            var id = dropped[0].innerText.split("#");
                            addTaskToPerson(id[0]);
                        } else if (droppedOn.attr('id') === "right-tab") {
                            var id = dropped[0].innerText.split("#");
                            fromPersonToCompleted(id[0]);
                        } else if (droppedOn.attr('id') === "left-tab") {
                            var id = dropped[0].innerText.split("#");
                            backToUnassigned(id[0]);
                        }
                        droppedOn.append($(dropped).removeAttr('style').css({position: "relative"}));
                    }
                });
            }

            // Task from unassigned tasks to a person;
            function addTaskToPerson(id) {
                var userName = '<%=userName%>';
                var string = "/NotMalware/webresources/person/" + userName + "/Notes";
                console.log("addTaskToPerson: " + id);
                $.ajax({
                    url: string,
                    type: 'PUT',
                    data: id,
                    contentType: 'text/plain',
                    async: false,
                    success: function (data) {

                    }
                });
            }

            // From persons tasks to his compeleted notes
            function fromPersonToCompleted(id) {
                var userName = '<%=userName%>';
                var string = "/NotMalware/webresources/person/" + userName + "/DoneNotes";
                console.log("fromPersonToCompleted: " + id);

                $.ajax({
                    url: string,
                    type: 'PUT',
                    data: id,
                    contentType: 'text/plain',
                    async: false,
                    success: function (data) {
                        console.log("das");
                    }, error: function (event) {
                        console.log("asd");
                        console.log(JSON.stringify(event));
                    }
                });
            }

            // Moving the note back to unassigned-panel
            function backToUnassigned(id) {
                var userName = '<%=userName%>';
                var string = "/NotMalware/webresources/person/" + userName + "/UnassignedNotes";
                console.log("Back to unassigned: " + id);
                // Ajax call to move the note back to unassigned
                $.ajax({
                    url: string,
                    type: 'PUT',
                    data: id,
                    contentType: 'text/plain',
                    async: false,
                    success: function (data) {
                        console.log("works");
                    }, error: function () {
                        console.log("not");
                    }
                });
            }

            $(document).ready(function () {
                // Setting the topbar username and job
                var userName = '<%=userName%>';
                var userp = document.getElementById("user");

                userp.innerHTML = userName;

                var jobp = document.getElementById("job");
                // Ajax call to set the correct job to top-panel
                $.ajax({
                    url: "/NotMalware/webresources/person/" + userName + "/accessLevel",
                    type: 'GET',
                    contentType: 'text/plain',
                    success: function (data) {
                        if (data === "0") {
                            jobp.innerHTML = "Admin";
                        } else if (data === "1") {
                            jobp.innerHTML = "Logistics";
                        } else if (data === "2") {
                            jobp.innerHTML = "Maintenance";
                        } else if (data === "3") {
                            jobp.innerHTML =  "Packer";
                        } else if (data === "4") {
                            jobp.innerHTML = "Janitor";
                        }
                    }
                });

                // Get the modal
                var modal = document.getElementById('myModal');

                // Get the <span> element that closes the modal
                var span = document.getElementsByClassName("close")[0];

                // Get the task adding button
                var add = document.getElementById('addtask');

                // When the user clicks on <span> (x), close the modal
                span.onclick = function () {
                    modal.style.display = "none";
                };

                // When the user clicks anywhere outside of the modal, close it
                window.onclick = function (event) {
                    if (event.target === modal) {
                        modal.style.display = "none";
                    }
                };

                $(function () {
                    $(".dropdown-menu li a").click(function () {
                        $(".btn:first-child").text($(this).text());
                        $(".btn:first-child").val($(this).text());
                    });
                });

                $(document).on('click', '#taskremove', function () {
                    // Getting the id of the note thats about to be deleted
                    var split = $(this).parent()[0].innerText.split("#");
                    var id = split[0];
                    // Removing the note from view
                    $(this).parent().parent().remove();

                    var userName = '<%=userName%>';
                    var string = "/NotMalware/webresources/person/" + userName + "/Delete";
                    console.log("Task remove: " + id);
                    // Ajax call to delete the note from the database
                    $.ajax({
                        url: string,
                        type: 'PUT',
                        data: id,
                        contentType: 'text/plain',
                        async: false,
                        success: function (data) {
                            console.log("fuck yea");
                        }, error: function () {
                            console.log("Something wentt wrong");
                        }
                    });
                });
                $("button[name='openmodal']").click(function () {
                    modal.style.display = "block";
                });
                // When the user adds note, close modal
                window.onclick = function (event) {
                    if (event.target === add) {
                        modal.style.display = "none";
                    }
                };
                
                // Adding tasks 
                $("button[name='addtask']").click(function () {
                    // Getting the header and message from the modal view
                    var header = titletextmodal.value;
                    var message = contenttextmodal.value;
                    var job = document.getElementById("fjob").value;
                    titletextmodal.value = "";
                    contenttextmodal.value = "";
                    console.log("Button -> addtask: " + header + "," + message + "," + job + "," + userName);
                    // Ajax call to make a note
                    $.ajax({
                        url: '/NotMalware/webresources/person/note',
                        type: 'PUT',
                        data: header + "," + message + "," + job + "," + userName,
                        contentType: 'text/plain',
                        async: false,
                        success: function (data) {
                        }
                    });
                    // Refreshing the unassigned notes panel
                    loadUnassigned();
                });
                // Refreshing the panels
                loadCompletedTasks();
                loadPersonTasks();
                loadUnassigned();
            }
            );

        </script>
    </head>
    <body>

        <nav id="header">
            <img src="css/img/logo.png" alt="Masterful design" id="logo">
            <form action="LogoutServlet" method="post">
                <input type="submit" role="button" value="Logout" id="logout" class="form-control btn btn-info note-input">
            </form>
            <a href="EditProfile.jsp" id="edit" role="button" class="form-control btn btn-info note-input" >Edit profile</a>
            <a href="AboutUs.jsp" id="about" role="button" type="button" class="form-control btn btn-info note-input" >About us</a>
            <a href="User.jsp" id="user" role="button" class="form-control btn btn-info note-input" ></a>
            <br style="clear: both;" />
            <div>
                <p id="job"></p>
            </div>
        </nav>


        <button id="openmodal" name="openmodal" class="btn btn-primary">Add Task</button>

        <div id="myModal" class="modal">
            <div class="modal-content">
                <span class="close glyphicon glyphicon-remove-circle" id="closeglyph"></span>
                <div class="addtaskforms">
                    <textarea class="form-control" placeholder="Add Title" id="titletextmodal"></textarea>
                </div>
                <div class="addtaskforms ">
                    <textarea class="form-control" placeholder="Add Content" id="contenttextmodal"></textarea>
                </div>
                <div>
                    <select name="jobs" id="fjob" class="selectjob">
                        <option value="0">Manager</option>
                        <option value="1">Logistics</option>
                        <option value="2">Packer</option>
                        <option value="3">Maintenance</option>
                        <option value="4">Janitor</option>
                    </select>
                </div>
                <button id="addtaskbuttons" name="addtask" type="button" class="btn btn-primary">Add task</button>
            </div>
        </div>
        <div id="taskdiv">
            <h4 id="taskdivname">Open tasks</h4>
            <h4 id="taskdivname">Your tasks</h4>
            <h4 id="taskdivname">Finished tasks</h4>
        </div>
        <div id="usertabs">

            <div id="left-tab" class="droppable"></div>
            <div id="middle-tab" class="droppable"></div>
            <div id="right-tab" class="droppable"></div>
            <br style="clear: both;" />
        </div>
        
        <a href="/NotMalware/admin.jsp" style="text-decoration: none; float: bottom">@</a>
        
    </body>
</html>
