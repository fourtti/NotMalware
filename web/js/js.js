/* 
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
 // Taskmaker to make the notes;
            function taskMaker(data, i) {
                var job = data.getElementsByTagName("note")[i].getElementsByTagName("accessLevel")[0].innerHTML;
                var jobname = "";
                if (job === "0") {
                    jobname = "Manager";
                } else if (job === "1") {
                    jobname = "Logistics";
                } else if (job === "2") {
                    jobname = "Packer";
                } else if (job === "3") {
                    jobname = "Maintenance";
                } else if (job === "4") {
                    jobname = "Janitor";
                }
//                var task = $("<div id='moveable' value='xx' class='ui-widget-header ui-draggable ui-draggable-handle'>\n\
//                                <span id='titletext'>" + data.getElementsByTagName("note")[i].getElementsByTagName("id")[0].innerHTML + "#   " + data.getElementsByTagName("note")[i].getElementsByTagName("heading")[0].innerHTML + " <span id='taskremove'class='glyphicon glyphicon-remove-circle'></span></span>\n\
//                                <textarea class='form-control' rows='5' id='notetext' placeholder='insert note text'>" + data.getElementsByTagName("note")[i].getElementsByTagName("content")[0].innerHTML + "</textarea></div>");
//                //addTask(task, "left");
                var task = $("<div id='moveable' class='ui-widget-header ui-draggable ui-draggable-handle'>\n\
                                <span id='titletext'>" + data.getElementsByTagName("note")[i].getElementsByTagName("id")[0].innerHTML + "#   " + data.getElementsByTagName("note")[i].getElementsByTagName("heading")[0].innerHTML + " <span id='taskremove'class='glyphicon glyphicon-remove-circle'></span></span>\n\
                                <div class='form-control' rows='5' id='notetext' placeholder='insert note text'>" + data.getElementsByTagName("note")[i].getElementsByTagName("content")[0].innerHTML + "<div style='border: 1px solid black; float: right; position: relative'>" + jobname + "</div></div></div>");

                console.log(task);
                return task;
            }

            function loadUnassigned() {
                // dont ask
                $.ajax({
                    url: '/NotMalware/webresources/person/UnassignedNotes',
                    type: 'GET',
                    dataType: 'xml',
                    success: function (data) {
                        if (data.getElementsByTagName("note").length === 0) {
                            console.log("Unassigned Empty");
                        } else {
                            // Creating the notes to the middle panel.
                            jQuery('#left-tab').html('');
                            for (var i = 0; i < data.getElementsByTagName("note").length; i++) {
                                var task = taskMaker(data, i);
                                addTask(task, "left");
                            }
                        }
                    }

                });
            }

            // Function to refresh persons tasks -panel
            function loadPersonTasks() {
                var userName = getUsername();
                var string = "/NotMalware/webresources/person/" + userName + "/Note";
                $.ajax({
                    url: string,
                    type: 'GET',
                    dataType: 'xml',
                    success: function (data) {
                        if (data.getElementsByTagName("note").length === 0) {
                            console.log("Person Empty");
                        } else {
                            // Creating the notes to the middle panel.
                            jQuery('#middle-tab').html('');
                            for (var i = 0; i < data.getElementsByTagName("note").length; i++) {
                                var task = taskMaker(data, i);
                                addTask(task, "center");
                            }
                        }
                    }
                });
            }

            // Function to refresh completed tasks -panel
            function loadCompletedTasks() {
                var userName = getUsername();
                var string = "/NotMalware/webresources/person/" + userName + "/DoneNotes";
                $.ajax({
                    url: string,
                    type: 'GET',
                    dataType: 'xml',
                    success: function (data) {
                        if (data.getElementsByTagName("note").length === 0) {
                            console.log("Completed Empty");
                        } else {
                            // Creating the notes to the right panel.
                            jQuery('#right-tab').html('');
                            for (var i = 0; i < data.getElementsByTagName("note").length; i++) {
                                var task = taskMaker(data, i);
                                addTask(task, "right");
                            }
                        }
                    }
                });
            }

            // Adding tasks with the certain note and panel as parameters
            function addTask(note, where) {
                // Setting the note to a panel where it's dropped
                if (where === "left") {
                    $("#left-tab").prepend(note);
                } else if (where === "center") {
                    $("#middle-tab").prepend(note);
                } else if (where === "right") {
                    $("#right-tab").prepend(note);
                }

                $("#moveable").draggable({
                    connectWith: "#left-tab, #middle-tab, #right-tab",
                    disable: false
                });
                // The dropping
                $(".droppable").droppable({
                    accept: "#moveable",
                    drop: function (event, ui) {
                        var dropped = ui.draggable;
                        var droppedOn = $(this);
                        // Checking the panel where it's dropped
                        if (droppedOn.attr('id') === "middle-tab") {
                            // Getting the notes id
                            var id = dropped[0].innerText.split("#");
                            addTaskToPerson(id[0]);
                        } else if (droppedOn.attr('id') === "right-tab") {
                            var id = dropped[0].innerText.split("#");
                            fromPersonToCompleted(id[0]);
                        } else if (droppedOn.attr('id') === "left-tab") {
                            var id = dropped[0].innerText.split("#");
                            backToUnassigned(id[0]);
                        }
                        droppedOn.append($(dropped).removeAttr('style').css({position: "relative"}));
                    }
                });
            }

            // Task from unassigned tasks to a person;
            function addTaskToPerson(id) {
                var userName = getUsername();
                var string = "/NotMalware/webresources/person/" + userName + "/Notes";
                console.log("addTaskToPerson: " + id);
                $.ajax({
                    url: string,
                    type: 'PUT',
                    data: id,
                    contentType: 'text/plain',
                    async: false,
                    success: function (data) {

                    }
                });
            }

            // From persons tasks to his compeleted notes
            function fromPersonToCompleted(id) {
                var userName = getUsername();
                var string = "/NotMalware/webresources/person/" + userName + "/DoneNotes";
                console.log("fromPersonToCompleted: " + id);

                $.ajax({
                    url: string,
                    type: 'PUT',
                    data: id,
                    contentType: 'text/plain',
                    async: false,
                    success: function (data) {
                        console.log("das");
                    }, error: function (event) {
                        console.log("asd");
                        console.log(JSON.stringify(event));
                    }
                });
            }

            // Moving the note back to unassigned-panel
            function backToUnassigned(id) {
                var userName = getUsername();
                var string = "/NotMalware/webresources/person/" + userName + "/UnassignedNotes";
                console.log("Back to unassigned: " + id);
                // Ajax call to move the note back to unassigned
                $.ajax({
                    url: string,
                    type: 'PUT',
                    data: id,
                    contentType: 'text/plain',
                    async: false,
                    success: function (data) {
                        console.log("works");
                    }, error: function () {
                        console.log("not");
                    }
                });
            }

            $(document).ready(function () {
                // Setting the topbar username and job
                var userName = getUsername();
                var userp = document.getElementById("user");

                userp.innerHTML = userName;

                var jobp = document.getElementById("job");
                var urlString = "/NotMalware/webresources/person/" + userName + "/accessLevel";

                // Ajax call to set the correct job to top-panel
                $.ajax({
                    url: urlString,
                    type: 'GET',
                    contentType: 'text/plain',
                    success: function (data) {
                        if (data === "0") {
                            jobp.innerHTML = "Admin";
                        } else if (data === "1") {
                            jobp.innerHTML = "Logistics";
                        } else if (data === "2") {
                            jobp.innerHTML = "Maintenance";
                        } else if (data === "3") {
                            jobp.innerHTML = "Packer";
                        } else if (data === "4") {
                            jobp.innerHTML = "Janitor";
                        }
                    }
                });

                // Get the modal
                var modal = document.getElementById('myModal');

                // Get the <span> element that closes the modal
                var span = document.getElementsByClassName("close")[0];

                // Get the task adding button
                var add = document.getElementById('addtask');

                // When the user clicks on <span> (x), close the modal
                span.onclick = function () {
                    modal.style.display = "none";
                };

                // When the user clicks anywhere outside of the modal, close it
                window.onclick = function (event) {
                    if (event.target === modal) {
                        modal.style.display = "none";
                    }
                };

                $(function () {

                    $(".dropdown-menu li a").click(function () {

                        $(".btn:first-child").text($(this).text());
                        $(".btn:first-child").val($(this).text());

                    });

                });

                $(document).on('click', '#taskremove', function () {
                    // Getting the id of the note thats about to be deleted
                    var split = $(this).parent()[0].innerText.split("#");
                    var id = split[0];
                    // Removing the note from view
                    $(this).parent().parent().remove();

                    var userName = getUsername();
                    var string = "/NotMalware/webresources/person/" + userName + "/Delete";
                    console.log("Task remove: " + id);
                    // Ajax call to delete the note from the database
                    $.ajax({
                        url: string,
                        type: 'PUT',
                        data: id,
                        contentType: 'text/plain',
                        async: false,
                        success: function (data) {
                            console.log("fuck yea");
                        }, error: function () {
                            console.log("Something wentt wrong");
                        }
                    });
                });
                $("button[name='openmodal']").click(function () {
                    modal.style.display = "block";
                });
                // When the user adds note, close modal
                window.onclick = function (event) {
                    if (event.target === add) {
                        modal.style.display = "none";
                    }
                };


                // Adding tasks 
                $("button[name='addtask']").click(function () {
                    // Getting the header and message from the modal view
                    var header = titletextmodal.value;
                    var message = contenttextmodal.value;
                    var job = document.getElementById("fjob").value;
                    titletextmodal.value = "";
                    contenttextmodal.value = "";
                    console.log("Button -> addtask: " + header + "," + message + "," + job + "," + userName);
                    // Ajax call to make a note
                    $.ajax({
                        url: '/NotMalware/webresources/person/note',
                        type: 'PUT',
                        data: header + "," + message + "," + job + "," + userName,
                        contentType: 'text/plain',
                        async: false,
                        success: function (data) {
                        }
                    });

                    // Refreshing the unassigned notes panel
                    loadUnassigned();

                });

                // Refreshing the panels
                loadCompletedTasks();
                loadPersonTasks();
                loadUnassigned();

                //$("moveable").sortable();
            }
            );

