<%-- 
    Document   : admin
    Created on : Mar 13, 2017, 10:00:32 AM
    Author     : vili
--%>
<%@page contentType="text/html" pageEncoding="UTF-8"%>
<!DOCTYPE html>
<html>
    <head>

        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <link rel="stylesheet" type="text/css" href="css/css.css">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

        <title>NotMalware</title>


        <script>
            // Cookie check
            <%
                String userName = null;
                Cookie[] cookies = request.getCookies();
                if (cookies != null) {
                    for (Cookie cookie : cookies) {
                        if (cookie.getName().equals("user")) {
                            userName = cookie.getValue();
                        }
                    }
                }
                // If the cookie doesn't have the correct username -> back to the front page
                if (userName == null) {
                    response.sendRedirect("Landing.jsp");
                }
            %>

            // Taskmaker to make the notes;
            function taskMaker(data, i) {
                var job = data.getElementsByTagName("note")[i].getElementsByTagName("accessLevel")[0].innerHTML;
                if (job === "0") {
                    job = "Manager";
                } else if (job === "1") {
                    job = "Logistics";
                } else if (job === "2") {
                    job = "Packer";
                } else if (job === "3") {
                    job = "Maintenance";
                } else if (job === "4") {
                    job = "Janitor";
                }
                
                // Task creation
                var task = $("<div class='ui-widget-header'>\n\
                                <span id='titletext'>" + data.getElementsByTagName("note")[i].getElementsByTagName("id")[0].innerHTML + "#   " + data.getElementsByTagName("note")[i].getElementsByTagName("heading")[0].innerHTML + " <span id='taskremove'class='glyphicon glyphicon-remove-circle'></span></span>\n\
                                <div class='form-control' rows='5' id='notetext' placeholder='insert note text'>" + data.getElementsByTagName("note")[i].getElementsByTagName("content")[0].innerHTML + "<div style='border: 1px solid black; float: right; position: relative'>" + jobname + "</div></div></div>");

                return task;
            }
            
            // Function to load all the unassigned notes

            function loadUnassigned() {
                //username from the cookie
                var job = '<%=userName%>';
                var string = '/NotMalware/webresources/person/' + job + '/UnassignedNotes';

                $.ajax({
                    url: string,
                    type: 'GET',
                    dataType: 'xml',
                    success: function (data) {
                        if (data.getElementsByTagName("note").length === 0) {
                            console.log("Unassigned Empty");
                        } else {
                            // Creating the notes to the middle panel.
                            jQuery('#left-tab').html('');
                            for (var i = 0; i < data.getElementsByTagName("note").length; i++) {
                                var task = taskMaker(data, i);
                                addTask(task, "left");
                            }
                        }
                    }

                });
            }

            // Function to refresh persons tasks -panel, takes the wanted person as parameter
            function loadPersonTasks(person) {
                var string = "/NotMalware/webresources/person/" + person + "/Note";
                $.ajax({
                    url: string,
                    type: 'GET',
                    dataType: 'xml',
                    success: function (data) {
                        if (data.getElementsByTagName("note").length === 0) {
                            console.log("Person Empty");
                        } else {
                            // Creating the notes to the middle panel.
                            jQuery('#middle-tab').html('');
                            for (var i = 0; i < data.getElementsByTagName("note").length; i++) {
                                var task = taskMaker(data, i);
                                addTask(task, "center");
                            }
                        }
                    }
                });
            }

            // Function to refresh completed tasks -panel, takes the wanted person as parameter
            function loadCompletedTasks(person) {
                var string = "/NotMalware/webresources/person/" + person + "/DoneNotes";
                $.ajax({
                    url: string,
                    type: 'GET',
                    dataType: 'xml',
                    success: function (data) {
                        if (data.getElementsByTagName("note").length === 0) {
                            console.log("Completed Empty");
                        } else {
                            // Creating the notes to the right panel.
                            jQuery('#right-tab').html('');
                            for (var i = 0; i < data.getElementsByTagName("note").length; i++) {
                                var task = taskMaker(data, i);
                                addTask(task, "right");
                            }
                        }
                    }
                });
            }

            // Adding tasks with the certain note and panel as parameters
            function addTask(note, where) {
                // Setting the note to a panel where it's dropped
                if (where === "left") {
                    $("#left-tab").prepend(note);
                } else if (where === "center") {
                    $("#middle-tab").prepend(note);
                } else if (where === "right") {
                    $("#right-tab").prepend(note);
                }

                $("#moveable").draggable({
                    connectWith: "#left-tab, #middle-tab, #right-tab",
                    disable: false
                });
                // The dropping
                $(".droppable").droppable({
                    accept: "#moveable",
                    drop: function (event, ui) {
                        var dropped = ui.draggable;
                        var droppedOn = $(this);
                        // Checking the panel where it's dropped
                        if (droppedOn.attr('id') === "middle-tab") {
                            // Getting the notes id
                            var id = dropped[0].innerText.split("#");
                            addTaskToPerson(id[0]);
                        } else if (droppedOn.attr('id') === "right-tab") {
                            var id = dropped[0].innerText.split("#");
                            fromPersonToCompleted(id[0]);
                        } else if (droppedOn.attr('id') === "left-tab") {
                            var id = dropped[0].innerText.split("#");
                            backToUnassigned(id[0]);
                        }
                        droppedOn.append($(dropped).removeAttr('style').css({position: "relative"}));
                    }
                });
            }
            
            
            // Function to get all the usernames from the database and appending them to the dropdown menu
            function loadSelection() {

                $.ajax({
                    url: "/NotMalware/webresources/person/All/Names",
                    type: "GET",
                    dataType: "xml",
                    async: false,
                    success: function (data) {
                        for (var i = 0; i < data.getElementsByTagName("name").length; i++) {
                            var string = '<option value="' + data.getElementsByTagName("name")[i].innerHTML + '">' + data.getElementsByTagName("name")[i].innerHTML + '</option>';
                            $('#selection').append(string);
                        }
                    }, error: function () {
                        console.log("wrong");
                    }
                });
            }

            // Loading the selected persons tasks
            function loadPerson() {
                // Name from the dropdown selection
                var e = document.getElementById("selection");
                var person = e.options[e.selectedIndex].value;
                // Emptying all the panels
                $('#middle-tab').html('');
                $('#left-tab').html('');
                $('#right-tab').html('');
                loadCompletedTasks(person);
                loadPersonTasks(person);
                loadUnassigned();
            }

            $(document).ready(function () {
                // Setting the topbar username and job
                var userName = '<%=userName%>';
                var userp = document.getElementById("user");

                userp.innerHTML = userName;

                var jobp = document.getElementById("job");
                // Ajax call to set the correct job to top-panel
                $.ajax({
                    url: "/NotMalware/webresources/person/" + userName + "/accessLevel",
                    type: 'GET',
                    contentType: 'text/plain',
                    success: function (data) {
                        if (data === "0") {
                            jobp.innerHTML = "Admin";
                        } else {
                            location.href = "/NotMalware/User.jsp";
                        }
                    }
                });

                $(document).on('click', '#taskremove', function () {
                    var e = document.getElementById("selection");
                    var person = e.options[e.selectedIndex].value;
                    // Getting the id of the note thats about to be deleted
                    var split = $(this).parent()[0].innerText.split("#");
                    var id = split[0];
                    // Removing the note from view
                    $(this).parent().parent().remove();

                    var string = "/NotMalware/webresources/person/" + person + "/Delete";
                    console.log("Task remove: " + id);
                    // Ajax call to delete the note from the database
                    $.ajax({
                        url: string,
                        type: 'PUT',
                        data: id,
                        contentType: 'text/plain',
                        async: false
                    });
                });

                loadSelection();

                // Refreshing the panels
                loadUnassigned();

                //$("moveable").sortable();
            }
            );
        </script>

    </head>
    <body>

        <nav id="header" class="navbar navbar-default">
            <img src="css/img/logo.png" alt="Masterful design" id="logo">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbartoggle">menu</button>
            <div id="navbartoggle" class="collapse navbar-collapse navbar-center navbar-main-collapse">
                <form action="LogoutServlet" method="post">
                    <input type="submit" role="button" value="Logout" id="logout" class="form-control btn btn-info note-input">
                </form>
                <a href="EditProfile.jsp" id="edit" role="button" class="form-control btn btn-info note-input" >Edit profile</a>
                <a href="AboutUs.jsp" id="about" role="button" type="button" class="form-control btn btn-info note-input" >About us</a>
                <a href="User.jsp" id="user" role="button" class="form-control btn btn-info note-input" ></a>
            </div>
            <br style="clear: both;" />
            <div>
                <p id="job" class="pagetext"></p>
            </div>
        </nav>

        <div id="taskdiv" style="margin-top: 100px">
            <div class="adminpagebutton">
                <select id="selection"></select>
                <input type="submit" onclick="loadPerson()" value="Set" class="form-control btn btn-info note-input landingbuttons" style="width:160px;">
            </div>
            <h4 id="taskdivname">All open tasks</h4>
            <h4 id="taskdivname">His/her tasks</h4>
            <h4 id="taskdivname">His/her finished tasks</h4>
        </div>
        <div id="usertabs">

            <div id="left-tab" class="droppable"></div>
            <div id="middle-tab" class="droppable"></div>
            <div id="right-tab" class="droppable"></div>
            <br style="clear: both;" />
        </div>
    </body>
</html>
